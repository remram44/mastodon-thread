<!DOCTYPE html>
<html>
  <head>
    <title>Mastodon thread</title>
  </head>
  <body>
    <h1>Tree view for ActivityPub</h1>

    <div id="explanation">
      <p>Use this app to load toots/notes from any ActivityPub server (that allows cross-site-scripting).</p>
      <p>This requires JavaScript.</p>
    </div>

    <form id="url-form" style="display: none;">
      <input type="text" id="url" value="https://mastodon.social/@Gargron/109289006695198209">
      <input type="submit" value="Load toot">
    </form>

    <div id="root" style="display: none;">
    </div>

    <script>
let urlForm = document.getElementById('url-form');
let root = document.getElementById('root');

urlForm.addEventListener('submit', function(evt) {
  evt.preventDefault();
  let url = document.getElementById('url').value;
  if(url && url.match(/^http/)) {
    window.location.hash = '#' + url;
  }
});

function urlChanged() {
  if(window.location.hash.match(/^#http/)) {
    // We have a URL to load

    // Hide explanations
    document.getElementById('explanation').setAttribute('style', 'display: none;');

    // Hide form
    urlForm.setAttribute('style', 'display: none;');

    // Show tree
    root.setAttribute('style', '');

    // Load toots
    (async function() {
      root.innerText = 'Loading...';

      // Load the provided toot
      const targetUrl = window.location.hash.substring(1);
      let res = await fetch(targetUrl, {
        headers: {'Accept': 'application/json'},
        mode: 'cors',
      });
      if(res.status !== 200) {
        throw new Error(res.status, targetUrl);
      }
      res = await res.json();
      let pageUrl = res.replies.first.next;

      // Load the replies, which might spawn multiple pages
      const replies = [];
      while(pageUrl) {
        res = await fetch(pageUrl, {
          headers: {'Accept': 'application/json'},
          mode: 'cors',
        });
        if(res.status !== 200) {
          throw new Error(res.status, pageUrl);
        }
        res = await res.json();
        if(!res.items || res.items.length === 0) {
          break;
        }
        replies.push(...res.items);
        pageUrl = res.next;
      }

      // TODO: Render
      root.innerText = JSON.stringify(replies);
    })();
  } else {
    // No URL provided

    // Show explanations
    document.getElementById('explanation').setAttribute('style', '');

    // Show form
    urlForm.setAttribute('style', '');

    // Hide content
    root.setAttribute('style', 'display: none;');
  }
}
urlChanged();
window.addEventListener('hashchange', urlChanged);
window.addEventListener('popstate', urlChanged);
    </script>
  </body>
</html>
